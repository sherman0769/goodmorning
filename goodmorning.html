<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>早安圖生成器</title>
  <style>
    :root{
      --bg:#0b0f14;--panel:#111827;--panel-2:#0f172a;--muted:#94a3b8;--accent:#22c55e;--line:#1f2937;--btn:#2563eb
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0b0f14);color:#e5e7eb;font-family:"Microsoft JhengHei", "Noto Sans TC", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"}
    .app{display:flex;gap:16px;min-height:100vh;padding:16px}
    .left{width:360px;max-width:46vw;background:var(--panel);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.4);display:flex;flex-direction:column}
    .right{flex:1;min-width:0;background:var(--panel-2);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.45);position:relative;display:flex;flex-direction:column}
    .header{padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .tabs{display:flex;gap:6px;padding:8px}
    .tab-btn{flex:1;padding:10px 12px;border:1px solid var(--line);background:#0f172a;color:#e5e7eb;border-radius:10px;cursor:pointer}
    .tab-btn[aria-selected="true"]{background:#1f2937}
    .panel{padding:12px 14px;display:none}
    .panel.active{display:block}
    .field{display:flex;flex-direction:column;gap:8px;margin:10px 0}
    .field label{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:8px}
    input[type="text"],input[type="number"],select,textarea{width:100%;background:#0b1220;color:#e5e7eb;border:1px solid #223047;border-radius:10px;padding:10px}
    input[type="color"]{width:100%;height:40px;border:1px solid #223047;border-radius:10px;background:#0b1220}
    .btn{appearance:none;border:1px solid #2b3344;background:linear-gradient(180deg,#1f2937,#111827);color:#e5e7eb;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#3b82f6,#1d4ed8);border-color:#1d4ed8}
    .btn.ghost{background:#0b1220}
    .btn.full{width:100%}
    .hint{font-size:12px;color:#9ca3af}

    /* 右側預覽 */
    .stage-wrap{position:relative;flex:1;display:flex;align-items:center;justify-content:center;padding:16px}
    canvas{max-width:100%;max-height:calc(100vh - 180px);border:1px dashed #334155;border-radius:12px;background:#0b1220}
    .overlay{position:absolute;inset:16px;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .drag-tip{position:absolute;bottom:22px;left:22px;background:rgba(0,0,0,.45);padding:6px 10px;border-radius:8px;font-size:12px;color:#cbd5e1}

    .footer{padding:12px 16px;border-top:1px solid var(--line);display:flex;gap:8px;flex-wrap:wrap}
    .spacer{flex:1}

    @media (max-width:980px){.app{flex-direction:column}.left{width:100%;max-width:none}}
  </style>
</head>
<body>
  <div class="app">
    <!-- 左側控制台 -->
    <aside class="left">
      <div class="header">
        <strong>早安圖控制台</strong>
        <span class="hint">本地離線使用</span>
      </div>

      <div class="tabs" role="tablist">
        <button class="tab-btn" id="tab-upload" role="tab" aria-controls="panel-upload" aria-selected="true">上傳圖像</button>
        <button class="tab-btn" id="tab-text" role="tab" aria-controls="panel-text" aria-selected="false">文字設定</button>
      </div>

      <!-- 上傳圖像面板 -->
      <section id="panel-upload" class="panel active" role="tabpanel" aria-labelledby="tab-upload">
        <div class="field">
          <label>選擇背景圖（JPG/PNG）</label>
          <input id="bgInput" type="file" accept="image/*" />
          <div class="hint">小技巧：建議使用 16:9 或手機常用比例，解析度越高輸出越清晰。</div>
        </div>
        <div class="field">
          <label>背景填充模式</label>
          <select id="fitMode">
            <option value="contain">等比置中（整張可見）</option>
            <option value="cover">等比裁切（鋪滿畫面）</option>
            <option value="stretch">拉伸鋪滿（可能變形）</option>
          </select>
        </div>
        <div class="field row">
          <button id="resetBtn" class="btn">重設</button>
          <button id="sampleBtn" class="btn ghost">載入示例背景</button>
        </div>
      </section>

      <!-- 文字設定面板 -->
      <section id="panel-text" class="panel" role="tabpanel" aria-labelledby="tab-text">
        <div class="field">
          <label>文字內容（可換行）</label>
          <textarea id="textInput" rows="3" placeholder="早安 ☀️ 祝你今天順利！"></textarea>
        </div>
        <div class="row">
          <div class="field" style="flex:1">
            <label>字體</label>
            <select id="fontFamily">
              <option value="'Microsoft JhengHei', 'Noto Sans TC', sans-serif">微軟正黑 / Noto Sans</option>
              <option value="'Noto Serif TC', serif">Noto Serif TC（襯線）</option>
              <option value="'PingFang TC', 'Heiti TC', 'Microsoft JhengHei', sans-serif">蘋方 / 黑體</option>
              <option value="'Roboto', 'Noto Sans TC', sans-serif">Roboto</option>
            </select>
          </div>
          <div class="field" style="width:120px">
            <label>字重</label>
            <select id="fontWeight">
              <option value="400">Regular</option>
              <option value="600">Semibold</option>
              <option value="700" selected>Bold</option>
              <option value="800">Extra Bold</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="field" style="flex:1">
            <label>字級（px）</label>
            <input id="fontSize" type="number" min="10" max="400" value="72" />
          </div>
          <div class="field" style="width:130px">
            <label>行距（倍數）</label>
            <input id="lineHeight" type="number" step="0.1" min="0.8" max="3" value="1.2" />
          </div>
        </div>
        <div class="row">
          <div class="field" style="flex:1">
            <label>文字顏色</label>
            <input id="fillColor" type="color" value="#ffffff" />
          </div>
          <div class="field" style="flex:1">
            <label>描邊顏色</label>
            <input id="strokeColor" type="color" value="#000000" />
          </div>
        </div>
        <div class="row">
          <div class="field" style="width:120px">
            <label>描邊粗細</label>
            <input id="strokeWidth" type="number" min="0" max="20" value="4" />
          </div>
          <div class="field" style="width:120px">
            <label>陰影透明度</label>
            <input id="shadowAlpha" type="number" step="0.05" min="0" max="1" value="0.35" />
          </div>
          <div class="field" style="width:120px">
            <label>陰影位移</label>
            <input id="shadowOffset" type="number" min="0" max="30" value="4" />
          </div>
        </div>
        <div class="row">
          <div class="field" style="flex:1">
            <label>對齊</label>
            <select id="align">
              <option value="center" selected>置中</option>
              <option value="left">靠左</option>
              <option value="right">靠右</option>
            </select>
          </div>
          <div class="field" style="flex:1">
            <label>自動換行邊界（%寬度）</label>
            <input id="wrapPercent" type="number" min="30" max="100" value="90" />
          </div>
        </div>
        <div class="hint">拖曳右側文字可移動位置；系統會自動以原圖解析度匯出高畫質 PNG。</div>
      </section>

      <div class="footer">
        <button id="downloadBtn" class="btn primary">下載 PNG</button>
        <button id="copyBtn" class="btn">複製到剪貼簿</button>
        <div class="spacer"></div>
        <span class="hint">© 2025 早安圖生成器</span>
      </div>
    </aside>

    <!-- 右側預覽區 -->
    <section class="right">
      <div class="header"><strong>即時預覽</strong><span id="sizeInfo" class="hint"></span></div>
      <div class="stage-wrap">
        <canvas id="stage" width="1280" height="720" aria-label="輸出畫布"></canvas>
        <div id="dragTip" class="drag-tip">拖曳文字移動位置</div>
      </div>
    </section>
  </div>

  <script>
    // 狀態
    const state = {
      img:null, imgW:1280, imgH:720,
      // 文字相對位置（以 0~1 表示）
      tx:0.5, ty:0.78,
      // 畫面設定
      fitMode:'contain'
    };

    // 元件
    const tabUpload = document.getElementById('tab-upload');
    const tabText = document.getElementById('tab-text');
    const panelUpload = document.getElementById('panel-upload');
    const panelText = document.getElementById('panel-text');
    const stage = document.getElementById('stage');
    const ctx = stage.getContext('2d');
    const sizeInfo = document.getElementById('sizeInfo');
    const dragTip = document.getElementById('dragTip');

    // 控制項
    const bgInput = document.getElementById('bgInput');
    const fitMode = document.getElementById('fitMode');
    const resetBtn = document.getElementById('resetBtn');
    const sampleBtn = document.getElementById('sampleBtn');

    const textInput = document.getElementById('textInput');
    const fontFamily = document.getElementById('fontFamily');
    const fontWeight = document.getElementById('fontWeight');
    const fontSize = document.getElementById('fontSize');
    const lineHeight = document.getElementById('lineHeight');
    const fillColor = document.getElementById('fillColor');
    const strokeColor = document.getElementById('strokeColor');
    const strokeWidth = document.getElementById('strokeWidth');
    const shadowAlpha = document.getElementById('shadowAlpha');
    const shadowOffset = document.getElementById('shadowOffset');
    const align = document.getElementById('align');
    const wrapPercent = document.getElementById('wrapPercent');

    const downloadBtn = document.getElementById('downloadBtn');
    const copyBtn = document.getElementById('copyBtn');

    // 標籤切換
    function setTab(which){
      const isUpload = which === 'upload';
      panelUpload.classList.toggle('active', isUpload);
      panelText.classList.toggle('active', !isUpload);
      tabUpload.setAttribute('aria-selected', isUpload ? 'true':'false');
      tabText.setAttribute('aria-selected', !isUpload ? 'true':'false');
    }
    tabUpload.addEventListener('click', ()=>setTab('upload'));
    tabText.addEventListener('click', ()=>setTab('text'));

    // 載入背景
    function loadImageFromFile(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = e => {
          const img = new Image();
          img.onload = ()=> resolve(img);
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    bgInput.addEventListener('change', async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const img = await loadImageFromFile(f);
      state.img = img; state.imgW = img.naturalWidth; state.imgH = img.naturalHeight;
      resizeCanvasToImage();
      render();
      setTab('text');
    });

    fitMode.addEventListener('change', ()=>{ state.fitMode = fitMode.value; render(); });
    resetBtn.addEventListener('click', ()=>{ state.tx=0.5; state.ty=0.78; render(); });

    // 載入示例（嵌入一張簡單漸層）
    sampleBtn.addEventListener('click', ()=>{
      const w=1600,h=900, c=document.createElement('canvas'); c.width=w; c.height=h; const x=c.getContext('2d');
      const g=x.createLinearGradient(0,0,0,h); g.addColorStop(0,'#f59e0b'); g.addColorStop(1,'#ef4444');
      x.fillStyle=g; x.fillRect(0,0,w,h);
      const img=new Image(); img.onload=()=>{state.img=img; state.imgW=w; state.imgH=h; resizeCanvasToImage(); render();};
      img.src=c.toDataURL('image/png');
    });

    // 自適應畫布大小（預覽）
    function resizeCanvasToImage(){
      // 依容器大小調整預覽解析度，保留比例
      const box = stage.parentElement.getBoundingClientRect();
      const maxW = Math.min(box.width-2, 1600);
      const ratio = state.imgW/state.imgH;
      const w = Math.round(maxW);
      const h = Math.round(w/ratio);
      stage.width = w; stage.height = h;
      sizeInfo.textContent = `預覽 ${w}×${h}｜原圖 ${state.imgW}×${state.imgH}`;
    }
    window.addEventListener('resize', ()=>{ if(state.img) resizeCanvasToImage(); render(); });

    // 文字拖曳
    let dragging=false; let dragStart=null;
    stage.addEventListener('pointerdown', (e)=>{
      const {offsetX, offsetY} = e; dragging=true; dragStart={x:offsetX,y:offsetY}; stage.setPointerCapture(e.pointerId);
    });
    stage.addEventListener('pointermove', (e)=>{
      if(!dragging) return;
      const {offsetX, offsetY} = e;
      state.tx = Math.max(0, Math.min(1, offsetX / stage.width));
      state.ty = Math.max(0, Math.min(1, offsetY / stage.height));
      render();
    });
    stage.addEventListener('pointerup', ()=>{ dragging=false; dragTip.style.display='none'; });

    // 繪製工具
    function drawImageFit(image, dx, dy, dW, dH, mode){
      const iw=image.naturalWidth, ih=image.naturalHeight; const ir=iw/ih; const dr=dW/dH;
      let sx=0, sy=0, sw=iw, sh=ih;
      if(mode==='cover'){
        if(ir>dr){ // 太寬 -> 裁左右
          sh=ih; sw=ih*dr; sx=(iw-sw)/2; sy=0;
        }else{ // 太高 -> 裁上下
          sw=iw; sh=iw/dr; sx=0; sy=(ih-sh)/2;
        }
      }else if(mode==='contain'){
        // 不裁切：計算目的尺寸置中
        let dw=dW, dh=dH; if(ir>dr){ dh=dW/ir; dy+=(dH-dh)/2; } else { dw=dH*ir; dx+=(dW-dw)/2; }
        ctx.drawImage(image, 0,0, iw, ih, dx, dy, dw, dh); return;
      }else if(mode==='stretch'){
        ctx.drawImage(image, 0,0, iw, ih, dx, dy, dW, dH); return;
      }
      ctx.drawImage(image, sx, sy, sw, sh, dx, dy, dW, dH);
    }

    function wrapLines(text, maxWidth){
      const words = text.split(/(\s+)/); // 保留空白
      const lines=[]; let line='';
      for(const w of words){
        const test=line + w; const m=ctx.measureText(test); if(m.width<=maxWidth||line===''){ line=test; }
        else{ lines.push(line.trimEnd()); line=w.trimStart(); }
      }
      if(line) lines.push(line.trimEnd());
      return lines.join('\n').split('\n');
    }

    function render(){
      const w=stage.width, h=stage.height; ctx.clearRect(0,0,w,h);
      // 背景
      ctx.fillStyle = '#0b1220'; ctx.fillRect(0,0,w,h);
      if(state.img){ drawImageFit(state.img,0,0,w,h,state.fitMode); }

      // 文字樣式
      const size = Number(fontSize.value)||72;
      const lh = Number(lineHeight.value)||1.2;
      const family = fontFamily.value;
      const weight = String(fontWeight.value);
      ctx.font = `${weight} ${size}px ${family}`;
      ctx.textAlign = align.value;
      ctx.textBaseline = 'middle';

      // 自動換行寬度
      const maxTextW = (Number(wrapPercent.value)||90)/100 * w;
      const lines = wrapLines(textInput.value||'早安 ☀️', maxTextW);

      // 位置（相對 -> 實際）
      let x = state.tx * w;
      let y = state.ty * h;

      // 計算文本區塊高度
      const lineH = size * lh; const blockH = lineH * lines.length;

      // 陰影 / 外框
      const sAlpha = Number(shadowAlpha.value)||0; const sOfs = Number(shadowOffset.value)||0;
      ctx.shadowColor = `rgba(0,0,0,${sAlpha})`;
      ctx.shadowBlur = Math.max(8, sOfs*2);
      ctx.shadowOffsetX = sOfs; ctx.shadowOffsetY = sOfs;

      // 填色與描邊
      const sw = Number(strokeWidth.value)||0;
      ctx.lineWidth = sw; ctx.strokeStyle = strokeColor.value; ctx.fillStyle = fillColor.value;

      // 對齊位置微調：置中時，讓多行視覺中心落在 y
      let startY = y - (blockH - lineH)/2;

      // 繪製每一行
      for(let i=0;i<lines.length;i++){
        const line = lines[i]; const ly = startY + i*lineH;
        if(sw>0) ctx.strokeText(line, x, ly);
        ctx.fillText(line, x, ly);
      }
    }

    // 下載高解析 PNG（以原圖尺寸匯出；若無背景則用預覽尺寸）
    function exportPNG(){
      const outW = state.img ? state.imgW : stage.width;
      const outH = state.img ? state.imgH : stage.height;
      const out = document.createElement('canvas'); out.width=outW; out.height=outH; const o=out.getContext('2d');
      // 背景
      o.fillStyle = '#0b1220'; o.fillRect(0,0,outW,outH);
      if(state.img){
        // 背景套用相同 fit 模式
        const mode=state.fitMode; const iw=state.imgW, ih=state.imgH; const ir=iw/ih; const dr=outW/outH;
        if(mode==='contain'){
          let dx=0,dy=0,dw=outW,dh=outH; if(ir>dr){ dh=outW/ir; dy=(outH-dh)/2; } else { dw=outH*ir; dx=(outW-dw)/2; }
          o.drawImage(state.img,0,0,iw,ih,dx,dy,dw,dh);
        }else if(mode==='cover'){
          let sx=0,sy=0,sw=iw,sh=ih; if(ir>dr){ sh=ih; sw=ih*dr; sx=(iw-sw)/2; } else { sw=iw; sh=iw/dr; sy=(ih-sh)/2; }
          o.drawImage(state.img,sx,sy,sw,sh,0,0,outW,outH);
        }else{
          o.drawImage(state.img,0,0,iw,ih,0,0,outW,outH);
        }
      }
      // 文字（依比例換算）
      const scaleX = outW / stage.width; const scaleY = outH / stage.height;
      const fontPx = (Number(fontSize.value)||72) * scaleX; // 以寬度比例為準
      const lh = Number(lineHeight.value)||1.2;
      const family = fontFamily.value; const weight= String(fontWeight.value);
      o.font = `${weight} ${fontPx}px ${family}`;
      o.textAlign = align.value; o.textBaseline='middle';
      const wrap = (Number(wrapPercent.value)||90)/100 * outW;

      // 計算換行（需以輸出字型重新量測）
      function wrapOut(text,maxW){
        const words = text.split(/(\s+)/); const lines=[]; let line='';
        for(const w of words){
          const t=line + w; const m=o.measureText(t); if(m.width<=maxW || line===''){ line=t; }
          else{ lines.push(line.trimEnd()); line=w.trimStart(); }
        }
        if(line) lines.push(line.trimEnd());
        return lines.join('\n').split('\n');
      }
      const lines = wrapOut(textInput.value||'早安 ☀️', wrap);
      const lineH = fontPx * lh; const blockH = lineH * lines.length;
      const x = state.tx * outW; const y = state.ty * outH; const startY = y - (blockH - lineH)/2;

      // 陰影 / 外框
      const sAlpha = Number(shadowAlpha.value)||0; const sOfs = Number(shadowOffset.value)||0;
      o.shadowColor = `rgba(0,0,0,${sAlpha})`; o.shadowBlur=Math.max(8,sOfs*2); o.shadowOffsetX=sOfs; o.shadowOffsetY=sOfs;
      const sw = (Number(strokeWidth.value)||0) * scaleX; o.lineWidth=sw; o.strokeStyle=strokeColor.value; o.fillStyle=fillColor.value;
      for(let i=0;i<lines.length;i++){
        const line = lines[i]; const ly = startY + i*lineH;
        if(sw>0) o.strokeText(line, x, ly);
        o.fillText(line, x, ly);
      }

      const url = out.toDataURL('image/png');
      const a=document.createElement('a'); a.href=url; a.download='good-morning.png'; a.click();
    }

    // 複製到剪貼簿（PNG）
    async function copyPNG(){
      const url = stage.toDataURL('image/png');
      const data = await (await fetch(url)).blob();
      try{
        await navigator.clipboard.write([new ClipboardItem({[data.type]: data})]);
        alert('已複製預覽 PNG 到剪貼簿');
      }catch(e){
        alert('瀏覽器不支援直接複製圖片，請改用「下載 PNG」。');
      }
    }

    // 綁定
    [textInput,fontFamily,fontWeight,fontSize,lineHeight,fillColor,strokeColor,strokeWidth,shadowAlpha,shadowOffset,align,wrapPercent]
      .forEach(el=> el.addEventListener('input', render));
    downloadBtn.addEventListener('click', exportPNG);
    copyBtn.addEventListener('click', copyPNG);

    // 初始
    resizeCanvasToImage();
    textInput.value = '早安 ☀️\n今天也要發光！';
    render();
  </script>
</body>
</html>
